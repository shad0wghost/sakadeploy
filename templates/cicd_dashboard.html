{% extends "base.html" %}

{% block content %}
    <h2>Dashboard for: {{ selected_repo }}</h2>

    <!-- System Resource Monitoring -->
    <div class="monitoring-section">
        <h3>System Monitoring</h3>
        <div class="charts-container">
            <div class="chart-wrapper"><canvas id="cpuChart"></canvas></div>
            <div class="chart-wrapper"><canvas id="ramChart"></canvas></div>
            <div class="chart-wrapper"><canvas id="diskChart"></canvas></div>
        </div>
    </div>

    <!-- Container Management -->
    <div class="container-section">
        <h3>Container Management</h3>
        <div id="container-list">
            <!-- Container statuses will be dynamically inserted here -->
        </div>
    </div>
    
    <!-- Control Panels -->
    <div class="controls-wrapper">
        <!-- Git/Repository Controls -->
        <div class="controls-section">
            <h3>Repository Controls</h3>
            <div class="main-controls">
                <button onclick="runGitAction('pull')">Git Pull</button>
                <button onclick="if(confirm('Are you sure you want to permanently delete the local repository folder? This cannot be undone.')) runGitAction('delete_repo')" class="btn-danger">Delete Local Repo</button>
            </div>
        </div>

        <!-- Docker Deployment Controls -->
        <div class="controls-section">
            <h3>Deployment Controls</h3>
            <div class="main-controls">
                <button onclick="runDockerAction('redeploy')">Redeploy (Pull & Build)</button>
                <button onclick="runDockerAction('stop')">Stop All</button>
                <button onclick="runDockerAction('prune')">Prune (Down)</button>
                <button onclick="runDockerAction('build_no_cache')">Build (No Cache)</button>
                <button onclick="runDockerAction('logs')">View All Logs</button>
            </div>
        </div>
    </div>

    <!-- Live Output Console -->
    <div class="output-section">
        <h3>Live Output</h3>
        <pre id="output-console"></pre>
    </div>

<script>
// --- Charting Logic (unchanged) ---
const cpuChartCtx = document.getElementById('cpuChart').getContext('2d');
// ... (rest of charting logic is the same)
const ramChartCtx = document.getElementById('ramChart').getContext('2d');
const diskChartCtx = document.getElementById('diskChart').getContext('2d');
function createChart(ctx, label) { /* ... same as before ... */ }
const cpuChart = createChart(cpuChartCtx, 'CPU Usage %');
const ramChart = createChart(ramChartCtx, 'RAM Usage %');
const diskChart = createChart(diskChartCtx, 'Disk Usage %');
async function updateCharts() { /* ... same as before ... */ }

// --- Container Management Logic (unchanged) ---
async function updateContainerStatus() { /* ... same as before ... */ }

// --- Action & Output Streaming Logic ---
let eventSource = null;

function handleStream(url, options = {}) {
    const outputConsole = document.getElementById('output-console');
    outputConsole.innerHTML = 'Connecting to stream...\n'; // Clear console on new action

    if (eventSource) {
        eventSource.close();
    }
    eventSource = new EventSource(url, options);
    eventSource.onmessage = function(event) {
        if (outputConsole.innerHTML === 'Connecting to stream...\n') {
            outputConsole.innerHTML = '';
        }
        // Create a text node to preserve whitespace and newlines
        outputConsole.appendChild(document.createTextNode(event.data));
        outputConsole.scrollTop = outputConsole.scrollHeight;
    };
    eventSource.onerror = function(error) {
        outputConsole.innerHTML += '\n--- Stream closed ---\n';
        eventSource.close();
        setTimeout(updateContainerStatus, 1000); 
    };
}

function runDockerAction(action, service = '') {
    let url = `/run_docker_action/${action}`;
    if (service) {
        url += `?service=${service}`;
    }
    handleStream(url, { method: 'POST' });
}

function runGitAction(action) {
    handleStream(`/run_git_action/${action}`, { method: 'POST' });
}

function runContainerAction(serviceName, action) {
    // Note: The logs button in the container list calls runDockerAction, not this.
    handleStream(`/api/container_action/${serviceName}/${action}`, { method: 'POST' });
}

// --- Initial Load and Periodic Updates (unchanged) ---
window.onload = function() {
    updateCharts();
    updateContainerStatus();
    setInterval(updateCharts, 5000);
    setInterval(updateContainerStatus, 10000);
};
</script>
{% endblock %}