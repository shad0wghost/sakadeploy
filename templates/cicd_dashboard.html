{% extends "base.html" %}

{% block content %}
    <h2>Dashboard for: {{ selected_repo }}</h2>

    <!-- Container Management -->
    <div class="container-section">
        <div class="container-header">
            <h3>Container Management</h3>
            <button onclick="updateContainerStatus()" class="refresh-btn">Refresh Containers</button>
        </div>
        <div id="container-list">
            <!-- Container statuses will be dynamically inserted here -->
        </div>
    </div>
    
    <!-- Control Panels -->
    <div class="controls-wrapper">
        <!-- Git/Repository Controls -->
        <div class="controls-section">
            <h3>Repository Controls</h3>
            <div class="main-controls">
                <button onclick="runGitAction('pull')">Git Pull</button>
                <button onclick="if(confirm('Are you sure you want to permanently delete the local repository folder? This cannot be undone.')) runGitAction('delete_repo')" class="btn-danger">Delete Local Repo</button>
            </div>
        </div>

        <!-- Docker Deployment Controls -->
        <div class="controls-section">
            <h3>Deployment Controls</h3>
            <div class="main-controls">
                <button onclick="runDockerAction('redeploy')">Redeploy (Pull & Build)</button>
                <button onclick="runDockerAction('start')">Start All</button>
                <button onclick="runDockerAction('stop')">Stop All</button>
                <button onclick="runDockerAction('prune')">Prune (Down)</button>
                <button onclick="runDockerAction('build_no_cache')">Build (No Cache)</button>
                <button onclick="runDockerAction('logs')">View All Logs</button>
            </div>
        </div>
    </div>

    <!-- Live Output Console -->
    <div class="output-section">
        <h3>Live Output</h3>
        <pre id="output-console"></pre>
    </div>

<script>
// --- Container Management Logic ---
async function updateContainerStatus() {
    try {
        const response = await fetch('/api/containers');
        const containers = await response.json();
        const containerListDiv = document.getElementById('container-list');

        if (containers.error) {
            containerListDiv.innerHTML = `<p class="error">Error: ${containers.details || containers.error}</p>`;
            return;
        }
        if (containers.length === 0) {
            containerListDiv.innerHTML = '<p>No containers found for this project. Use "Redeploy" to get started.</p>';
            return;
        }

                let html = '<table>';

                html += '<tr><th>Service</th><th>Image</th><th>Command</th><th>Ports</th><th>Status</th><th>Actions</th></tr>';

                

                containers.forEach(c => {

                    const statusClass = c.State === 'running' ? 'status-running' : 'status-stopped';

                    html += `

                        <tr>

                            <td>${c.Service}</td>

                            <td>${c.Image || 'N/A'}</td>

                            <td>${c.Command || 'N/A'}</td>

                            <td>${c.Ports || '-'}</td>

                            <td><span class="status-indicator ${statusClass}">${c.Status || c.State}</span></td>

                            <td class="action-buttons">

                                <button onclick="runContainerAction('${c.Service}', 'start')">Start</button>

                                <button onclick="runContainerAction('${c.Service}', 'stop')">Stop</button>

                                <button onclick="runContainerAction('${c.Service}', 'restart')">Restart</button>

                                <button onclick="runContainerAction('${c.Service}', 'rm -f')">Delete</button>

                                <button onclick="runDockerAction('logs', '${c.Service}')">Logs</button>

                            </td>

                        </tr>

                    `;

                });

                html += '</table>';
        containerListDiv.innerHTML = html;
    } catch (error) {
        console.error('Error fetching container status:', error);
        document.getElementById('container-list').innerHTML = '<p class="error">Failed to load container status.</p>';
    }
}

// --- Action & Output Streaming Logic ---
let eventSource = null;

function handleStream(url) {
    const outputConsole = document.getElementById('output-console');
    outputConsole.innerHTML = 'Connecting to stream...\n';

    if (eventSource) {
        eventSource.close();
    }
    eventSource = new EventSource(url);
    eventSource.onmessage = function(event) {
        if (outputConsole.innerHTML === 'Connecting to stream...\n') {
            outputConsole.innerHTML = '';
        }
        // Append the data and explicitly add a newline for consistent wrapping
        outputConsole.innerHTML += event.data + '\n';
        outputConsole.scrollTop = outputConsole.scrollHeight;
    };
    eventSource.onerror = function(error) {
        outputConsole.appendChild(document.createTextNode('\n--- Stream closed ---\n'));
        outputConsole.scrollTop = outputConsole.scrollHeight;
        eventSource.close();
        setTimeout(updateContainerStatus, 1000); 
    };
}

function runDockerAction(action, service = '') {
    let url = `/run_docker_action/${action}`;
    if (service) {
        url += `?service=${service}`;
    }
    handleStream(url);
}

function runGitAction(action) {
    handleStream(`/run_git_action/${action}`);
}

function runContainerAction(serviceName, action) {
    handleStream(`/api/container_action/${serviceName}/${action}`);
}

// --- Initial Load and Periodic Updates ---
document.addEventListener('DOMContentLoaded', function() {
    updateContainerStatus();
    setInterval(updateContainerStatus, 3000); // Update container status every 3 seconds
});
</script>
{% endblock %}