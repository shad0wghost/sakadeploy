{% extends "base.html" %}

{% block content %}
    <h2>Dashboard for: {{ selected_repo }}</h2>

    <!-- System Resource Monitoring -->
    <div class="monitoring-section">
        <h3>System Monitoring</h3>
        <div class="charts-container">
            <div class="chart-wrapper">
                <canvas id="cpuChart"></canvas>
            </div>
            <div class="chart-wrapper">
                <canvas id="ramChart"></canvas>
            </div>
            <div class="disk-wrapper">
                <h4>Disk Usage</h4>
                <div class="progress-bar-container">
                    <div id="diskProgressBar" class="progress-bar-fill"></div>
                </div>
                <span id="diskUsageText"></span>
            </div>
        </div>
    </div>

    <!-- Container Management -->
    <div class="container-section">
        <div class="container-header">
            <h3>Container Management</h3>
            <button onclick="updateContainerStatus()" class="refresh-btn">Refresh Containers</button>
        </div>
        <div id="container-list">
            <!-- Container statuses will be dynamically inserted here -->
        </div>
    </div>
    
    <!-- Control Panels -->
    <div class="controls-wrapper">
        <!-- Git/Repository Controls -->
        <div class="controls-section">
            <h3>Repository Controls</h3>
            <div class="main-controls">
                <button onclick="runGitAction('pull')">Git Pull</button>
                <button onclick="if(confirm('Are you sure you want to permanently delete the local repository folder? This cannot be undone.')) runGitAction('delete_repo')" class="btn-danger">Delete Local Repo</button>
            </div>
        </div>

        <!-- Docker Deployment Controls -->
        <div class="controls-section">
            <h3>Deployment Controls</h3>
            <div class="main-controls">
                <button onclick="runDockerAction('redeploy')">Redeploy (Pull & Build)</button>
                <button onclick="runDockerAction('start')">Start All</button>
                <button onclick="runDockerAction('stop')">Stop All</button>
                <button onclick="runDockerAction('prune')">Prune (Down)</button>
                <button onclick="if(confirm('Are you sure you want to remove ALL unused Docker images on this system? This can affect other projects.')) runDockerAction('prune_images')" class="btn-danger">Prune All Images</button>
                <button onclick="runDockerAction('build_no_cache')">Build (No Cache)</button>
                <button onclick="runDockerAction('logs')">View All Logs</button>
            </div>
        </div>
    </div>

    <!-- Live Output Console -->
    <div class="output-section">
        <h3>Live Output</h3>
        <pre id="output-console"></pre>
    </div>

<script>
// --- Charting & Monitoring Logic ---
function createChart(ctx, label) {
    return new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: label,
                data: [],
                borderColor: 'rgba(75, 192, 192, 1)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                borderWidth: 1.5,
                fill: true,
                tension: 0.4,
                pointRadius: 0
            }]
        },
        options: {
            scales: {
                y: { beginAtZero: true, max: 100, ticks: { callback: value => value + "%" } },
                x: { ticks: { display: false } }
            },
            plugins: { legend: { display: false } },
            responsive: true,
            maintainAspectRatio: false
        }
    });
}

const cpuChart = createChart(document.getElementById('cpuChart').getContext('2d'), 'CPU Usage %');
const ramChart = createChart(document.getElementById('ramChart').getContext('2d'), 'RAM Usage %');

async function updateSystemStats() {
    try {
        const response = await fetch('/api/system_stats');
        const data = await response.json();
        if (!data || data.length === 0) return;

        const labels = data.map(d => new Date(d.ts * 1000).toLocaleTimeString());
        
        // Update charts
        cpuChart.data.labels = labels;
        cpuChart.data.datasets[0].data = data.map(d => d.cpu);
        cpuChart.update('none');

        ramChart.data.labels = labels;
        ramChart.data.datasets[0].data = data.map(d => d.ram);
        ramChart.update('none');
        
        // Update disk progress bar
        const latestDiskUsage = data[data.length - 1].disk;
        document.getElementById('diskProgressBar').style.width = latestDiskUsage + '%';
        document.getElementById('diskUsageText').textContent = latestDiskUsage.toFixed(1) + '%';

    } catch (error) {
        console.error('Error fetching system stats:', error);
    }
}


// --- Container Management Logic ---
async function updateContainerStatus() {
    // ... (unchanged)
}

// --- Action & Output Streaming Logic ---
// ... (unchanged)
let eventSource = null;
function handleStream(url) { /* ... */ }
function runDockerAction(action, service = '') { /* ... */ }
function runGitAction(action) { /* ... */ }
function runContainerAction(serviceName, action) { /* ... */ }


// --- Initial Load and Periodic Updates ---
document.addEventListener('DOMContentLoaded', function() {
    updateSystemStats();
    updateContainerStatus();
    setInterval(updateSystemStats, 5000); // Update stats every 5 seconds
    setInterval(updateContainerStatus, 3000);
});
</script>
{% endblock %}
