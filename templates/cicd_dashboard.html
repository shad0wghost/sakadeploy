{% extends "base.html" %}

{% block content %}
    <h2>Dashboard <span class="repo-subtitle">{% if selected_repo %}(Project: {{ selected_repo }}){% endif %}</span></h2>

    <!-- System Resource Monitoring -->
    <div class="monitoring-section">
        <h3>System Monitoring</h3>
        <div class="charts-container">
            <div class="chart-wrapper">
                <h4>CPU Usage</h4>
                <canvas id="cpuChart"></canvas>
            </div>
            <div class="chart-wrapper">
                <h4>RAM Usage</h4>
                <canvas id="ramChart"></canvas>
            </div>
            <div class="chart-wrapper">
                <h4>Network I/O (Mbps)</h4>
                <canvas id="netChart"></canvas>
            </div>
            <div class="disk-wrapper">
                <h4>Disk Usage</h4>
                <div class="progress-bar-container">
                    <div id="diskProgressBar" class="progress-bar-fill"></div>
                </div>
                <span id="diskUsageText"></span>
            </div>
        </div>
    </div>

    <!-- Container Management (System-Wide) -->
    <div class="container-section">
        <div class="container-header">
            <h3>System-Wide Container Management</h3>
            <button onclick="updateContainerStatus()" class="refresh-btn">Refresh Containers</button>
        </div>
        <div id="container-list">
            <p>Loading container data...</p>
        </div>
    </div>
    
    <!-- Control Panels -->
    <div class="controls-wrapper">
        <div class="controls-section">
            <h3>Project Deployment Controls <span class="repo-subtitle">{% if selected_repo %}({{ selected_repo }}){% else %}(No Project Selected){% endif %}</span></h3>
            <div class="main-controls">
                <button onclick="runDockerAction('redeploy')" class="btn-success">Redeploy (Pull & Build)</button>
                <button onclick="runGitAction('pull')">Git Pull</button>
                <button onclick="runDockerAction('start')">Start Project</button>
                <button onclick="runDockerAction('stop')">Stop Project</button>
                <button onclick="runDockerAction('prune')">Prune Project</button>
                <button onclick="runDockerAction('build_no_cache')">Build (No Cache)</button>
                <button onclick="runDockerAction('logs')">Project Logs</button>
            </div>
        </div>
        <div class="controls-section">
            <h3>Global System Controls</h3>
            <div class="main-controls">
                <button onclick="if(confirm('Are you sure you want to stop and remove ALL containers on this system? THIS IS A HIGHLY DESTRUCTIVE ACTION.')) runDockerAction('prune_containers')" class="btn-danger">Prune All Containers</button>
                <button onclick="if(confirm('Are you sure you want to remove ALL unused Docker images on this system? This can affect other projects.')) runDockerAction('prune_images')" class="btn-danger">Prune All Images</button>
                <button onclick="if(confirm('Are you sure you want to permanently delete the local repository folder for the selected project? This cannot be undone.')) runGitAction('delete_repo')" class="btn-danger">Delete Local Repo</button>
            </div>
        </div>
    </div>

    <!-- Live Output Console -->
    <div class="output-section">
        <h3>Live Output</h3>
        <pre id="output-console"></pre>
    </div>

<script>
// --- Charting & Monitoring Logic ---
function createChart(ctx, label, yLabel = '%') {
    return new Chart(ctx, {
        type: 'line',
        data: { labels: [], datasets: [{ label: label, data: [], borderColor: 'rgba(75, 192, 192, 1)', backgroundColor: 'rgba(75, 192, 192, 0.2)', borderWidth: 1.5, fill: true, tension: 0.4, pointRadius: 0 }] },
        options: {
            scales: { y: { beginAtZero: true, ticks: { callback: value => value + yLabel } }, x: { ticks: { display: false } } },
            plugins: { legend: { display: false } },
            responsive: true, maintainAspectRatio: false
        }
    });
}
const cpuChart = createChart(document.getElementById('cpuChart').getContext('2d'), 'CPU Usage');
const ramChart = createChart(document.getElementById('ramChart').getContext('2d'), 'RAM Usage');
const netChart = new Chart(document.getElementById('netChart').getContext('2d'), {
    type: 'line',
    data: {
        labels: [],
        datasets: [
            { label: 'Sent', data: [], borderColor: 'rgba(255, 99, 132, 1)', backgroundColor: 'rgba(255, 99, 132, 0.2)', borderWidth: 1.5, fill: true, tension: 0.4, pointRadius: 0 },
            { label: 'Received', data: [], borderColor: 'rgba(54, 162, 235, 1)', backgroundColor: 'rgba(54, 162, 235, 0.2)', borderWidth: 1.5, fill: true, tension: 0.4, pointRadius: 0 }
        ]
    },
    options: {
        scales: { y: { beginAtZero: true, ticks: { callback: value => value + ' Mbps' } }, x: { ticks: { display: false } } },
        plugins: { legend: { display: true, position: 'bottom', labels: { boxWidth: 12 } } },
        responsive: true, maintainAspectRatio: false
    }
});

async function updateSystemStats() {
    try {
        const response = await fetch('/api/system_stats');
        const data = await response.json();
        if (!data || data.length === 0) return;

        const labels = data.map(d => new Date(d.ts * 1000).toLocaleTimeString());
        
        cpuChart.data.labels = labels;
        cpuChart.data.datasets[0].data = data.map(d => d.cpu);
        cpuChart.update('none');

        ramChart.data.labels = labels;
        ramChart.data.datasets[0].data = data.map(d => d.ram);
        ramChart.update('none');
        
        netChart.data.labels = labels;
        netChart.data.datasets[0].data = data.map(d => d.net_sent);
        netChart.data.datasets[1].data = data.map(d => d.net_recv);
        netChart.update('none');

        const latestDiskUsage = data[data.length - 1].disk;
        document.getElementById('diskProgressBar').style.width = latestDiskUsage + '%';
        document.getElementById('diskUsageText').textContent = latestDiskUsage.toFixed(1) + '%';
    } catch (error) {
        console.error('Error fetching system stats:', error);
    }
}

// --- Container Management Logic (with Highlighting) ---
async function updateContainerStatus() {
    try {
        const response = await fetch('/api/containers');
        const containers = await response.json();
        const containerListDiv = document.getElementById('container-list');

        if (containers.error) {
            containerListDiv.innerHTML = `<p class="error">Error: ${containers.details || containers.error}</p>`;
            return;
        }
        if (containers.length === 0) {
            containerListDiv.innerHTML = '<p>No containers found on this system.</p>';
            return;
        }

        let html = '<table>';
        html += '<tr><th>Name(s)</th><th>Image</th><th>Ports</th><th>Status</th><th>Actions</th></tr>';
        containers.forEach(c => {
            const isRunning = c.State === 'running';
            const statusClass = isRunning ? 'status-running' : 'status-stopped';
            const projectClass = c.is_project_container ? 'project-container-row' : '';
            const containerId = c.ID;
            const serviceName = c.compose_service;
            
            let rebuildButton = '';
            if (projectClass && serviceName) {
                rebuildButton = `<button onclick="runContainerAction('${containerId}', 'rebuild', '${serviceName}')">Rebuild</button>`;
            }

            html += `
                <tr class="${projectClass}">
                    <td>${c.Names || 'N/A'}</td>
                    <td>${c.Image || 'N/A'}</td>
                    <td>${c.Ports || '-'}</td>
                    <td><span class="status-indicator ${statusClass}">${c.Status}</span></td>
                    <td class="action-buttons">
                        <button onclick="runContainerAction('${containerId}', 'start')" ${isRunning ? 'disabled' : ''}>Start</button>
                        <button onclick="runContainerAction('${containerId}', 'stop')" ${!isRunning ? 'disabled' : ''}>Stop</button>
                        <button onclick="runContainerAction('${containerId}', 'restart')">Restart</button>
                        <button onclick="runContainerAction('${containerId}', 'logs')">Logs</button>
                        ${rebuildButton}
                        <button onclick="if(confirm('Are you sure you want to stop and remove this container?')) runContainerAction('${containerId}', 'rm')" class="btn-danger">Delete</button>
                    </td>
                </tr>
            `;
        });
        html += '</table>';
        containerListDiv.innerHTML = html;
    } catch (error) {
        console.error('Error fetching container status:', error);
        document.getElementById('container-list').innerHTML = '<p class="error">Failed to load container status.</p>';
    }
}

// --- Action & Output Streaming Logic ---
let eventSource = null;
function handleStream(url) {
    const outputConsole = document.getElementById('output-console');
    outputConsole.textContent = 'Connecting to stream...\n';

    if (eventSource) { eventSource.close(); }
    eventSource = new EventSource(url);
    eventSource.onmessage = function(event) {
        if (outputConsole.textContent === 'Connecting to stream...\n') { outputConsole.innerHTML = ''; }
        // Force line breaks by using innerHTML and appending <br>
        outputConsole.innerHTML += event.data.replace(/\n/g, '<br>') + '<br>';
        outputConsole.scrollTop = outputConsole.scrollHeight;
    };
    eventSource.onerror = function(error) {
        outputConsole.innerHTML += '<br>--- Stream closed ---<br>';
        outputConsole.scrollTop = outputConsole.scrollHeight;
        eventSource.close();
        setTimeout(updateContainerStatus, 1000); 
    };
}

// Project-specific actions
function runDockerAction(action) {
    handleStream(`/run_docker_action/${action}`);
}
function runGitAction(action) {
    handleStream(`/run_git_action/${action}`);
}

// Global container-specific actions
function runContainerAction(containerId, action, serviceName = '') {
    let url = `/api/container_action/${containerId}/${action}`;
    if (serviceName) {
        url += `?service_name=${serviceName}`;
    }
    handleStream(url);
}

// --- Initial Load and Periodic Updates ---
document.addEventListener('DOMContentLoaded', function() {
    updateSystemStats();
    updateContainerStatus();
    setInterval(updateSystemStats, 1000);
    setInterval(updateContainerStatus, 1000);
});
</script>
{% endblock %}